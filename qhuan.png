<?php
define('ADMIN_USERNAME','admin');     // Admin Username
define('ADMIN_PASSWORD','ljwhly');      // Admin Password
define('API_PASSWORD','88888');

session_start();
error_reporting(E_ALL & ~E_NOTICE & ~E_WARNING);
date_default_timezone_set("Asia/Shanghai");
header("Content-type:text/html;charset=utf-8");
$load = 5;
include_once("sql.php");
$console = "BLUE娱乐";
$db['host'] = "127.0.0.1";
$db['user'] = "fly_bird";
$db['pass'] = "fly_bird";
$db['name'] = "fly_birdcom_80_711";
$dbconn = db_connect($db['host'], $db['user'], $db['pass'], $db['name']);
$wx['ID'] = 'wxa0bf279906abe45a'; //微信公众号ID
$wx['key'] = '47d1549de17fa825e378d0888674f236'; //微信公众号密匙

$gmidAli=[];
$gmidAli[1]='pk10';//澳洲10
$gmidAli[2]='xyft';//幸运飞艇
$gmidAli[3]='cqssc';//
$gmidAli[4]='xy28';
$gmidAli[5]='jnd28';
$gmidAli[6]='jsmt';
$gmidAli[7]='jssc';
$gmidAli[8]='jsssc';
function getreferer(){
    $list = [
        'Xiaomi_M1808D2TT_TD-LTE/V1 Linux/4.4.78 Android/8.1 Release/10.10.2018 Browser/AppleWebKit537.36 Mobile Safari/537.36 System/Android 8.1 XiaoMi/MiuiBrowser/9.8.3',
        'Xiaomi_M1804C3CT_TD-LTE/V1 Linux/4.9.77 Android/8.1 Release/4.25.2018 Browser/AppleWebKit537.36 Mobile Safari/537.36 System/Android 8.1 XiaoMi/MiuiBrowser/9.5.9',
        'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/534.24 (KHTML, like Gecko) Chrome/71.0.3578.141 Safari/534.24 XiaoMi/MiuiBrowser/11.1.11',
        'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/534.24 (KHTML, like Gecko) Chrome/71.0.3578.141 Safari/534.24 XiaoMi/MiuiBrowser/11.0.10',
        'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/534.24 (KHTML, like Gecko) Chrome/71.0.3578.141 Safari/534.24 XiaoMi/MiuiBrowser/10.9.2',
        'Mozilla/5.0 (Windows; U; Windows NT 5.2; en-US) AppleWebKit/537.36(KHTML, like Gecko) Chrome/40.0.2214.89 Safari/537.36',
        'Mozilla/5.0 (Windows; U; Windows NT 5.2; en-US) AppleWebKit/537.36 (KHTML, like Gecko) Safari/537.36 VivoBrowser/7.1.0.1 Chrome/62.0.3202.84',
        'Mozilla/5.0 (Windows; U; Windows NT 5.2; en-US) AppleWebKit/537.36 (KHTML, like Gecko) Safari/537.36 VivoBrowser/7.0.1.2 Chrome/62.0.3202.84',
        'Mozilla/5.0 (Windows; U; Windows NT 5.2; en-US) AppleWebKit/537.36 (KHTML, like Gecko) Safari/537.36 VivoBrowser/6.7.11.3 Chrome/62.0.3202.84',
        'Mozilla/5.0 (Windows; U; Windows NT 5.2; en-US) AppleWebKit/537.36 (KHTML, like Gecko) Safari/537.36 VivoBrowser/6.6.3.0 Chrome/62.0.3202.84',
        'Mozilla/5.0 (Windows; U; Windows NT 5.2; en-US) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/57.0.2987.108 Safari/537.36 UCBrowser/12.7.9.1059',
        'Mozilla/5.0 (Windows; U; Windows NT 5.2; en-US) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/57.0.2987.108 Safari/537.36 UCBrowser/12.7.5.1055',
        'Mozilla/5.0 (Windows; U; Windows NT 5.2; en-US) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/57.0.2987.108 Safari/537.36 UCBrowser/12.7.4.1054',
        'Mozilla/5.0 (Windows; U; Windows NT 5.2; en-US) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/57.0.2987.108 Safari/537.36 UCBrowser/12.7.2.1052',
        'Mozilla/5.0 (Windows; U; Windows NT 5.2; en-US) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/57.0.2987.108 Safari/537.36 UCBrowser/12.7.0.1050',
        'Mozilla/5.0 (Windows; U; Windows NT 5.2; en-US) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/57.0.2987.108 Safari/537.36 UCBrowser/12.6.2.1042',
        'Mozilla/5.0 (Windows NT 6.3; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/74.0.3729.169 Safari/537.36',
        'Mozilla/5.0 (Windows NT 6.3; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/77.0.3865.90 Safari/537.36',
        'Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/74.0.3729.169 Safari/537.36',
        'Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/74.0.3729.108 Safari/537.36',
        'Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/73.0.3683.86 Safari/537.36',
        'Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/70.0.3538.25 Safari/537.36 Core/1.70.3741.400 QQBrowser/10.5.3863.400',
        'Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/70.0.3538.25 Safari/537.36 Core/1.70.3704.400 QQBrowser/10.4.3587.400',
        'Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/69.0.3947.100 Safari/537.36',
        'Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/69.0.3497.100 Safari/537.36',
        'Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/65.0.3314.0 Safari/537.36 SE 2.X MetaSr 1.0',
        'Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/63.0.3239.26 Safari/537.36 Core/1.63.5977.400 LBBROWSER/10.1.3752.400',
        'Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/63.0.3239.132 Safari/537.36',
        'Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/62.0.3202.97 Safari/537.36 huaweioem',
        'Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/55.0.2883.87 Safari/537.36',
        'Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/53.0.2785.116 Safari/537.36 QBCore/4.0.1278.400 QQBrowser/9.0.2524.400 Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/53.0.2875.116 Safari/537.36 NetType/WIFI MicroMessenger/7.0.5 WindowsWechat',
        'Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/53.0.2785.116 Safari/537.36 QBCore/4.0.1258.400 QQBrowser/9.0.2524.400 Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/53.0.2875.116 Safari',
        'Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/53.0.2785.116 Safari/537.36 QBCore/4.0.1219.400 QQBrowser/9.0.2524.400 Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/39.0.2171.95 Safari/537.36 MicroMessenger/6.5.2.501 NetType/WIFI WindowsWechat',
        'Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/53.0.2785.116 Safari/537.36 QBCore/4.0.1219.400 QQBrowser/9.0.2524.400 Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/39.0.2171.95 Safari/dd',
    ];
    $randIndex = array_rand($list);
    return $list[$randIndex];
}
function curlFn($url){
    $ch = curl_init();

    curl_setopt($ch, CURLOPT_ENCODING, "gzip");
    curl_setopt($ch, CURLOPT_USERAGENT, "Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1; .NET CLR 1.1.4322; .NET CLR 2.0.50727)");
    curl_setopt($ch, CURLOPT_USERAGENT, getreferer());// 模拟用户使用的浏览器

    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true); // 获取数据返回

    curl_setopt($ch, CURLOPT_FOLLOWLOCATION, 1);
    curl_setopt($ch, CURLOPT_CONNECTTIMEOUT, 3);
    curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);
    curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, false);

    $res = curl_exec($ch);
    $curl_errno = curl_errno($ch);
    if ($curl_errno) {
        curl_close($ch);
        return false;
    }
    curl_close($ch);
    print_r($res);die();
    return $res;
}
function getGameTxtName($gameid=''){
    $gmidName=[];
    $gmidName[1]='澳洲幸运10';
    $gmidName[2]='幸运飞艇';
    $gmidName[3]='极速飞艇';
    $gmidName[4]='极速赛车';
    $gmidName[5]='加拿大28';
    $gmidName[6]='极速摩托/飞艇';
    /*$gmidName[7]='jssc';
    $gmidName[8]='jsssc';*/
    if(empty($gameid)) return $gmidName;
    else return (isset($gmidName[$gameid])?$gmidName[$gameid]:'----');
}

function getGameTxtNameByCode($code){
    $gimeid=getGameIdByCode($code);
    return getGameTxtName($gimeid);
}

function getGameIdByCode($code=''){
    global $gmidAli;
    $typeNum=$gmidAli;
    $typeNum=array_flip($typeNum);
    if(empty($code)) return $typeNum;
    else return (isset($typeNum[$code])?$typeNum[$code]:'----');
}

//$oauth = 'http://jump.0933888.net/?t=' . $_SERVER['HTTP_HOST'];
//$oauth = 'http://' . $_SERVER['HTTP_HOST'].'/?room='.$_SESSION['roomid'];
$oauth = "http://qwe.wqzyh.top/get-weixin-code.html?appid=".$wx["ID"]."&redirect_uri=".urlencode("http://".$_SERVER["HTTP_HOST"]."/qr.php?agent=".$_GET['agent']."&g=".$_GET['g']."&room=".$_GET['room'])."&response_type=code&scope=snsapi_userinfo&state=STATE#wechat_redirect";
function room_isOK($roomid){
    $status = get_query_val('fn_room', 'id', array('roomid' => $roomid));
    if($status == ""){
        return false;
    }
    return true;
}
function wx_gettoken($Appid, $Appkey, $code){
    $url = "https://api.weixin.qq.com/sns/oauth2/access_token?appid=" . $Appid . "&secret=" . $Appkey . "&code=" . $code . "&grant_type=authorization_code";
    $html = file_get_contents($url);
    $json = json_decode($html, 1);
    $access_token = $json['access_token'];
    $openid = $json['openid'];
    return array("token" => $access_token, 'openid' => $openid);
}
//2017-10-21 获取全局access token 
// function wx_getaccesstoken($Appid, $Appkey){
    // $url = "https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid=". $Appid ."&secret=". $Appkey;
    // $html = file_get_contents($url);
    // $json = json_decode($html, 1);
    // $access_token = $json['access_token'];
    // $expires = $json['expires_in'];
    // return array("access_token" => $access_token, 'expires_in' => $expires);
// }
//用全局access token 和 openid 获取用户详情
// function wx_getinfo2($token, $openid){
    // $url = "https://api.weixin.qq.com/cgi-bin/user/info?access_token=". $token ."&openid=". $openid;
    // $html = file_get_contents($url);
    // $json = json_decode($html, 1);
    // $nickname = $json['nickname'];
    // $headhtml = $json['headimgurl'];
    // return array("nickname" => $nickname, 'headimg' => $headhtml);
// }

function wx_getinfo($token, $openid){
    $url = "https://api.weixin.qq.com/sns/userinfo?access_token=" . $token . "&openid=" . $openid."&lang=zh_CN";
    $html = file_get_contents($url);
    $json = json_decode($html, 1);
    $nickname = $json['nickname'];
    $headhtml = $json['headimgurl'];
    return array("nickname" => $nickname, 'headimg' => $headhtml);
}
function U_create($userid, $username, $headimg, $agent = "null"){
    if($agent == ""){
        $agent = 'null';
    }
    //insert_query("fn_user", array("userid" => $userid, 'username' => $username, 'headimg' => $_SESSION['headimg'], 'money' => '0', 'roomid' => $_SESSION['roomid'], 'statustime' => time(), 'agent' => $agent, 'isagent' => 'false', 'jia' => 'false'));
	insert_query("fn_user", array("userid" => $userid, 'username' => $username, 'headimg' => $headimg, 'money' => '0', 'roomid' => $_SESSION['roomid'], 'statustime' => time(), 'agent' => $agent, 'isagent' => 'false', 'jia' => 'false'));
    return true;
}
function U_isOK($userid, $headimg){
    $status = get_query_val('fn_user', 'id', array('userid' => $userid, 'roomid' => $_SESSION['roomid']));
    if($status == ""){
        return false;
    }
    update_query("fn_user", array("headimg" => $headimg), array('id' => $status));
    return true;
}
function ajaxMsg($msg,$status=1){
    if(is_string($msg)) $data=['msg'=>$msg,'status'=>$status];
    else{
        $data=['status'=>$status];
        $data=array_merge($data,$msg);
    }
    
    echo json_encode($data);
    exit();
}
function getOpenInfo($gameName){
    global $gmidAli;
    $typeNum=$gmidAli;
    $typeNum=array_flip($typeNum);
    $_COOKIE['game']=$gameName;
    $roomid=$_SESSION['roomid'];
    $GameType=$typeNum[$gameName];
    $field = 'term,next_term,next_time,code';
    $BetTerm = get_query_vals('fn_open', $field, "type = {$GameType} order by `next_time` desc limit 1");
    //$time = (int)get_query_val('fn_lottery'.$GameType, 'fengtime', array('roomid' => $roomid));
    $thisTerm=explode(',',$BetTerm['code']);
    //var_dump($thisTerm);exit;
    if($GameType == 5){
        $h=intval($thisTerm[0])+intval($thisTerm[1])+intval($thisTerm[2]);
    }else{
        $h=intval($thisTerm[0])+intval($thisTerm[1]);
    }

    $rowsend=[];
    $rowsend['current_sn']=$BetTerm['term'];
    $rowsend['next_sn']=$BetTerm['next_term'];
    $rowsend['letf_time']=strtotime($BetTerm['next_time'])-GetTtime();
    $rowsend['open_num']=$BetTerm['code'];
    $rowsend['fp_time']=1;
    $rowsend['gyh']=$h.' '.($h>10?'大':'小').' '.($h%2==0?'双':'单');
    return $rowsend;
}

function GetTtime(){
//    $data=file_get_contents('http://127.0.0.1:1323');
//    if (!empty($data)){
//        return strtotime($data);
//    }
    return time();
}